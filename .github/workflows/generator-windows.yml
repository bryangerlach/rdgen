name: Custom Windows Client Generator

on:
  workflow_dispatch:
    inputs:
      server:
        description: 'Relay Server'
        required: true
      key:
        description: 'Public Key'
        required: true
      apiServer:
        description: 'API Server'
        required: true
      custom:
        description: 'Custom Config (Base64)'
        required: true
      uuid:
        description: 'Job UUID'
        required: true
      appname:
        description: 'Application Name'
        required: true
      filename:
        description: 'Output Filename'
        required: true
      extras:
        description: 'Extra parameters (JSON)'
        required: true
      iconlink:
        description: 'Icon Download Link'
        required: false
      logolink:
        description: 'Logo Download Link'
        required: false

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4 # Version stable actuelle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
            flutter-version: '3.24.4' # Version recommandée pour RustDesk
            channel: 'stable'

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      - name: Install Dependencies
        run: |
          vcpkg install sqlite3:x86_64-windows-static
          pip install requests

      - name: Run Build Script
        shell: bash
        run: |
          # Ici le script va injecter tes variables dans le code source de RustDesk
          # On utilise python pour traiter les extras et l'URL de retour (Ngrok)
          python rdgenerator/builder.py \
            --platform windows \
            --server "${{ github.event.inputs.server }}" \
            --key "${{ github.event.inputs.key }}" \
            --api "${{ github.event.inputs.apiServer }}" \
            --custom "${{ github.event.inputs.custom }}" \
            --uuid "${{ github.event.inputs.uuid }}" \
            --appname "${{ github.event.inputs.appname }}" \
            --extras '${{ github.event.inputs.extras }}'

      - name: Upload Result to API (Ngrok)
        shell: bash
        run: |
          # Récupération de l'URL Ngrok via les extras
          GENURL=$(echo '${{ github.event.inputs.extras }}' | jq -r '.genurl')
          
          echo "Envoi du fichier vers : $GENURL"
          
          curl -X POST -F "file=@${{ github.event.inputs.filename }}.exe" \
               -F "uuid=${{ github.event.inputs.uuid }}" \
               -F "status=Finished" \
               "$GENURL/update_github_run"
